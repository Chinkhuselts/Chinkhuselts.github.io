<!DOCTYPE html>
<html>
    <head>
        <title>Global Threat Map - Moving Visualization</title>
        <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body {
                margin: 0;
                padding: 0;
                background-color: #0a0a1a;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    Arial, sans-serif;
                overflow: hidden;
                color: white;
            }

            #globe-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                z-index: 1;
            }

            .controls {
                position: absolute;
                top: 10px;
                left: 10px;
                z-index: 1000;
                background: rgba(0, 0, 0, 0.85);
                padding: 15px;
                border-radius: 8px;
                color: white;
                border: 2px solid #4CAF50;
                backdrop-filter: blur(10px);
                max-width: 300px;
            }

            #fileInput {
                padding: 10px 15px;
                background: #4CAF50;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
                width: 100%;
                transition: background 0.2s;
                margin-top: 10px;
            }

            #fileInput:hover {
                background: #45a049;
            }

            .title {
                font-size: 16px;
                font-weight: bold;
                color: #4CAF50;
                margin-bottom: 10px;
            }

            #legend {
                position: absolute;
                top: 10px;
                right: 10px;
                z-index: 1000;
                background: rgba(0, 0, 0, 0.85);
                padding: 15px;
                border-radius: 8px;
                color: white;
                font-size: 12px;
                border: 1px solid #555;
                max-width: 250px;
                backdrop-filter: blur(10px);
            }

            #stats {
                position: absolute;
                bottom: 10px;
                left: 10px;
                z-index: 1000;
                background: rgba(0, 0, 0, 0.85);
                padding: 15px;
                border-radius: 8px;
                color: white;
                font-size: 13px;
                border: 1px solid #555;
                backdrop-filter: blur(10px);
            }

            #status {
                position: absolute;
                top: 120px;
                left: 10px;
                z-index: 1000;
                background: rgba(0, 0, 0, 0.85);
                padding: 10px 15px;
                border-radius: 5px;
                color: #4CAF50;
                font-size: 12px;
                display: none;
                max-width: 350px;
                border: 1px solid #4CAF50;
                backdrop-filter: blur(10px);
            }

            .color-legend {
                display: flex;
                align-items: center;
                margin: 6px 0;
            }

            .color-box {
                width: 30px;
                height: 15px;
                margin-right: 10px;
                border: 1px solid #fff;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            }

            .stat-row {
                display: flex;
                justify-content: space-between;
                margin: 4px 0;
            }

            .stat-label {
                color: #aaa;
            }

            .stat-value {
                font-weight: bold;
                color: #4CAF50;
            }

            #instructions {
                position: absolute;
                bottom: 10px;
                right: 10px;
                z-index: 1000;
                background: rgba(0, 0, 0, 0.7);
                padding: 10px;
                border-radius: 5px;
                font-size: 11px;
                color: #ccc;
                max-width: 200px;
            }

            .country-label {
                position: absolute;
                background: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 10px;
                pointer-events: none;
                z-index: 100;
                white-space: nowrap;
                border: 1px solid rgba(255, 255, 255, 0.3);
                transform: translate(-50%, -100%);
            }

            .route-info {
                position: absolute;
                top: 150px;
                left: 10px;
                z-index: 1000;
                background: rgba(0, 0, 0, 0.85);
                padding: 10px 15px;
                border-radius: 5px;
                color: white;
                font-size: 11px;
                border: 1px solid #555;
                backdrop-filter: blur(10px);
                max-width: 300px;
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="controls">
            <div class="title">üåç GLOBAL THREAT MAP</div>
            <div style="color: #aaa; font-size: 11px">
                DDOS Attack Visualization
            </div>
            <input type="file" id="fileInput" accept=".csv" />
        </div>

        <div id="status">Ready</div>

        <div id="globe-container"></div>

        <div class="route-info" id="routeInfo"></div>

        <div id="legend">
            <strong>üéØ Target: Ulaanbaatar, Mongolia</strong><br /><br />
            <strong>Attack Intensity:</strong><br />
            <div class="color-legend">
                <div class="color-box" style="background: #9D4EDD"></div>
                <span>1-100</span>
            </div>
            <div class="color-legend">
                <div class="color-box" style="background: #4D96FF"></div>
                <span>101-250</span>
            </div>
            <div class="color-legend">
                <div class="color-box" style="background: #6BCF7F"></div>
                <span>251-500</span>
            </div>
            <div class="color-legend">
                <div class="color-box" style="background: #FFD93D"></div>
                <span>501-1K</span>
            </div>
            <div class="color-legend">
                <div class="color-box" style="background: #FFA500"></div>
                <span>1K-2.5K</span>
            </div>
            <div class="color-legend">
                <div class="color-box" style="background: #FF6B6B"></div>
                <span>2.5K+</span>
            </div>
        </div>

        <div id="stats">
            <strong>üìä Statistics</strong><br />
            <div class="stat-row">
                <span class="stat-label">Total Rows:</span>
                <span class="stat-value" id="totalRows">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Valid IPs:</span>
                <span class="stat-value" id="validIPs">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Unique IPs:</span>
                <span class="stat-value" id="uniqueIPs">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Cached:</span>
                <span class="stat-value" id="cachedIPs">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">"Multiple":</span>
                <span class="stat-value" id="multipleCount">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Countries:</span>
                <span class="stat-value" id="uniqueCountries">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Top:</span>
                <span class="stat-value" id="topCountry" style="font-size: 11px"
                    >-</span
                >
            </div>
        </div>

        <div id="instructions">
            Drag to rotate globe<br />
            Scroll to zoom<br />
            Right-click drag to pan<br />
            Click on routes for details
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

        <script>
                    const TARGET = { lat: 47.9039153, lng: 106.9120097 };

                    const COUNTRY_COORDS = {
            'AD': { lat: 42.546245, lng: 1.601554, name: 'Andorra' },
            'AE': { lat: 23.424076, lng: 53.847818, name: 'United Arab Emirates' },
            'AF': { lat: 33.93911, lng: 67.709953, name: 'Afghanistan' },
            'AG': { lat: 17.060816, lng: -61.796428, name: 'Antigua and Barbuda' },
            'AI': { lat: 18.220554, lng: -63.068615, name: 'Anguilla' },
            'AL': { lat: 41.153332, lng: 20.168331, name: 'Albania' },
            'AM': { lat: 40.069099, lng: 45.038189, name: 'Armenia' },
            'AN': { lat: 12.226079, lng: -69.060087, name: 'Netherlands Antilles' },
            'AO': { lat: -11.202692, lng: 17.873887, name: 'Angola' },
            'AQ': { lat: -75.250973, lng: -0.071389, name: 'Antarctica' },
            'AR': { lat: -38.416097, lng: -63.616672, name: 'Argentina' },
            'AS': { lat: -14.270972, lng: -170.132217, name: 'American Samoa' },
            'AT': { lat: 47.516231, lng: 14.550072, name: 'Austria' },
            'AU': { lat: -25.274398, lng: 133.775136, name: 'Australia' },
            'AW': { lat: 12.52111, lng: -69.968338, name: 'Aruba' },
            'AZ': { lat: 40.143105, lng: 47.576927, name: 'Azerbaijan' },
            'BA': { lat: 43.915886, lng: 17.679076, name: 'Bosnia and Herzegovina' },
            'BB': { lat: 13.193887, lng: -59.543198, name: 'Barbados' },
            'BD': { lat: 23.684994, lng: 90.356331, name: 'Bangladesh' },
            'BE': { lat: 50.503887, lng: 4.469936, name: 'Belgium' },
            'BF': { lat: 12.238333, lng: -1.561593, name: 'Burkina Faso' },
            'BG': { lat: 42.733883, lng: 25.48583, name: 'Bulgaria' },
            'BH': { lat: 25.930414, lng: 50.637772, name: 'Bahrain' },
            'BI': { lat: -3.373056, lng: 29.918886, name: 'Burundi' },
            'BJ': { lat: 9.30769, lng: 2.315834, name: 'Benin' },
            'BM': { lat: 32.321384, lng: -64.75737, name: 'Bermuda' },
            'BN': { lat: 4.535277, lng: 114.727669, name: 'Brunei' },
            'BO': { lat: -16.290154, lng: -63.588653, name: 'Bolivia' },
            'BR': { lat: -14.235004, lng: -51.92528, name: 'Brazil' },
            'BS': { lat: 25.03428, lng: -77.39628, name: 'Bahamas' },
            'BT': { lat: 27.514162, lng: 90.433601, name: 'Bhutan' },
            'BV': { lat: -54.423199, lng: 3.413194, name: 'Bouvet Island' },
            'BW': { lat: -22.328474, lng: 24.684866, name: 'Botswana' },
            'BY': { lat: 53.709807, lng: 27.953389, name: 'Belarus' },
            'BZ': { lat: 17.189877, lng: -88.49765, name: 'Belize' },
            'CA': { lat: 56.130366, lng: -106.346771, name: 'Canada' },
            'CC': { lat: -12.164165, lng: 96.870956, name: 'Cocos [Keeling] Islands' },
            'CD': { lat: -4.038333, lng: 21.758664, name: 'Congo [DRC]' },
            'CF': { lat: 6.611111, lng: 20.939444, name: 'Central African Republic' },
            'CG': { lat: -0.228021, lng: 15.827659, name: 'Congo [Republic]' },
            'CH': { lat: 46.818188, lng: 8.227512, name: 'Switzerland' },
            'CI': { lat: 7.539989, lng: -5.54708, name: 'C√¥te d\'Ivoire' },
            'CK': { lat: -21.236736, lng: -159.777671, name: 'Cook Islands' },
            'CL': { lat: -35.675147, lng: -71.542969, name: 'Chile' },
            'CM': { lat: 7.369722, lng: 12.354722, name: 'Cameroon' },
            'CN': { lat: 35.86166, lng: 104.195397, name: 'China' },
            'CO': { lat: 4.570868, lng: -74.297333, name: 'Colombia' },
            'CR': { lat: 9.748917, lng: -83.753428, name: 'Costa Rica' },
            'CU': { lat: 21.521757, lng: -77.781167, name: 'Cuba' },
            'CV': { lat: 16.002082, lng: -24.013197, name: 'Cape Verde' },
            'CX': { lat: -10.447525, lng: 105.690449, name: 'Christmas Island' },
            'CY': { lat: 35.126413, lng: 33.429859, name: 'Cyprus' },
            'CZ': { lat: 49.817492, lng: 15.472962, name: 'Czech Republic' },
            'DE': { lat: 51.165691, lng: 10.451526, name: 'Germany' },
            'DJ': { lat: 11.825138, lng: 42.590275, name: 'Djibouti' },
            'DK': { lat: 56.26392, lng: 9.501785, name: 'Denmark' },
            'DM': { lat: 15.414999, lng: -61.370976, name: 'Dominica' },
            'DO': { lat: 18.735693, lng: -70.162651, name: 'Dominican Republic' },
            'DZ': { lat: 28.033886, lng: 1.659626, name: 'Algeria' },
            'EC': { lat: -1.831239, lng: -78.183406, name: 'Ecuador' },
            'EE': { lat: 58.595272, lng: 25.013607, name: 'Estonia' },
            'EG': { lat: 26.820553, lng: 30.802498, name: 'Egypt' },
            'EH': { lat: 24.215527, lng: -12.885834, name: 'Western Sahara' },
            'ER': { lat: 15.179384, lng: 39.782334, name: 'Eritrea' },
            'ES': { lat: 40.463667, lng: -3.74922, name: 'Spain' },
            'ET': { lat: 9.145, lng: 40.489673, name: 'Ethiopia' },
            'FI': { lat: 61.92411, lng: 25.748151, name: 'Finland' },
            'FJ': { lat: -16.578193, lng: 179.414413, name: 'Fiji' },
            'FK': { lat: -51.796253, lng: -59.523613, name: 'Falkland Islands [Islas Malvinas]' },
            'FM': { lat: 7.425554, lng: 150.550812, name: 'Micronesia' },
            'FO': { lat: 61.892635, lng: -6.911806, name: 'Faroe Islands' },
            'FR': { lat: 46.227638, lng: 2.213749, name: 'France' },
            'GA': { lat: -0.803689, lng: 11.609444, name: 'Gabon' },
            'GB': { lat: 55.378051, lng: -3.435973, name: 'United Kingdom' },
            'GD': { lat: 12.262776, lng: -61.604171, name: 'Grenada' },
            'GE': { lat: 42.315407, lng: 43.356892, name: 'Georgia' },
            'GF': { lat: 3.933889, lng: -53.125782, name: 'French Guiana' },
            'GG': { lat: 49.465691, lng: -2.585278, name: 'Guernsey' },
            'GH': { lat: 7.946527, lng: -1.023194, name: 'Ghana' },
            'GI': { lat: 36.137741, lng: -5.345374, name: 'Gibraltar' },
            'GL': { lat: 71.706936, lng: -42.604303, name: 'Greenland' },
            'GM': { lat: 13.443182, lng: -15.310139, name: 'Gambia' },
            'GN': { lat: 9.945587, lng: -9.696645, name: 'Guinea' },
            'GP': { lat: 16.995971, lng: -62.067641, name: 'Guadeloupe' },
            'GQ': { lat: 1.650801, lng: 10.267895, name: 'Equatorial Guinea' },
            'GR': { lat: 39.074208, lng: 21.824312, name: 'Greece' },
            'GS': { lat: -54.429579, lng: -36.587909, name: 'South Georgia and the South Sandwich Islands' },
            'GT': { lat: 15.783471, lng: -90.230759, name: 'Guatemala' },
            'GU': { lat: 13.444304, lng: 144.793731, name: 'Guam' },
            'GW': { lat: 11.803749, lng: -15.180413, name: 'Guinea-Bissau' },
            'GY': { lat: 4.860416, lng: -58.93018, name: 'Guyana' },
            'GZ': { lat: 31.354676, lng: 34.308825, name: 'Gaza Strip' },
            'HK': { lat: 22.396428, lng: 114.109497, name: 'Hong Kong' },
            'HM': { lat: -53.08181, lng: 73.504158, name: 'Heard Island and McDonald Islands' },
            'HN': { lat: 15.199999, lng: -86.241905, name: 'Honduras' },
            'HR': { lat: 45.1, lng: 15.2, name: 'Croatia' },
            'HT': { lat: 18.971187, lng: -72.285215, name: 'Haiti' },
            'HU': { lat: 47.162494, lng: 19.503304, name: 'Hungary' },
            'ID': { lat: -0.789275, lng: 113.921327, name: 'Indonesia' },
            'IE': { lat: 53.41291, lng: -8.24389, name: 'Ireland' },
            'IL': { lat: 31.046051, lng: 34.851612, name: 'Israel' },
            'IM': { lat: 54.236107, lng: -4.548056, name: 'Isle of Man' },
            'IN': { lat: 20.593684, lng: 78.96288, name: 'India' },
            'IO': { lat: -6.343194, lng: 71.876519, name: 'British Indian Ocean Territory' },
            'IQ': { lat: 33.223191, lng: 43.679291, name: 'Iraq' },
            'IR': { lat: 32.427908, lng: 53.688046, name: 'Iran' },
            'IS': { lat: 64.963051, lng: -19.020835, name: 'Iceland' },
            'IT': { lat: 41.87194, lng: 12.56738, name: 'Italy' },
            'JE': { lat: 49.214439, lng: -2.13125, name: 'Jersey' },
            'JM': { lat: 18.109581, lng: -77.297508, name: 'Jamaica' },
            'JO': { lat: 30.585164, lng: 36.238414, name: 'Jordan' },
            'JP': { lat: 36.204824, lng: 138.252924, name: 'Japan' },
            'KE': { lat: -0.023559, lng: 37.906193, name: 'Kenya' },
            'KG': { lat: 41.20438, lng: 74.766098, name: 'Kyrgyzstan' },
            'KH': { lat: 12.565679, lng: 104.990963, name: 'Cambodia' },
            'KI': { lat: -3.370417, lng: -168.734039, name: 'Kiribati' },
            'KM': { lat: -11.875001, lng: 43.872219, name: 'Comoros' },
            'KN': { lat: 17.357822, lng: -62.782998, name: 'Saint Kitts and Nevis' },
            'KP': { lat: 40.339852, lng: 127.510093, name: 'North Korea' },
            'KR': { lat: 35.907757, lng: 127.766922, name: 'South Korea' },
            'KW': { lat: 29.31166, lng: 47.481766, name: 'Kuwait' },
            'KY': { lat: 19.513469, lng: -80.566956, name: 'Cayman Islands' },
            'KZ': { lat: 48.019573, lng: 66.923684, name: 'Kazakhstan' },
            'LA': { lat: 19.85627, lng: 102.495496, name: 'Laos' },
            'LB': { lat: 33.854721, lng: 35.862285, name: 'Lebanon' },
            'LC': { lat: 13.909444, lng: -60.978893, name: 'Saint Lucia' },
            'LI': { lat: 47.166, lng: 9.555373, name: 'Liechtenstein' },
            'LK': { lat: 7.873054, lng: 80.771797, name: 'Sri Lanka' },
            'LR': { lat: 6.428055, lng: -9.429499, name: 'Liberia' },
            'LS': { lat: -29.609988, lng: 28.233608, name: 'Lesotho' },
            'LT': { lat: 55.169438, lng: 23.881275, name: 'Lithuania' },
            'LU': { lat: 49.815273, lng: 6.129583, name: 'Luxembourg' },
            'LV': { lat: 56.879635, lng: 24.603189, name: 'Latvia' },
            'LY': { lat: 26.3351, lng: 17.228331, name: 'Libya' },
            'MA': { lat: 31.791702, lng: -7.09262, name: 'Morocco' },
            'MC': { lat: 43.750298, lng: 7.412841, name: 'Monaco' },
            'MD': { lat: 47.411631, lng: 28.369885, name: 'Moldova' },
            'ME': { lat: 42.708678, lng: 19.37439, name: 'Montenegro' },
            'MG': { lat: -18.766947, lng: 46.869107, name: 'Madagascar' },
            'MH': { lat: 7.131474, lng: 171.184478, name: 'Marshall Islands' },
            'MK': { lat: 41.608635, lng: 21.745275, name: 'Macedonia [FYROM]' },
            'ML': { lat: 17.570692, lng: -3.996166, name: 'Mali' },
            'MM': { lat: 21.913965, lng: 95.956223, name: 'Myanmar [Burma]' },
            'MN': { lat: 46.862496, lng: 103.846656, name: 'Mongolia' },
            'MO': { lat: 22.198745, lng: 113.543873, name: 'Macau' },
            'MP': { lat: 17.33083, lng: 145.38469, name: 'Northern Mariana Islands' },
            'MQ': { lat: 14.641528, lng: -61.024174, name: 'Martinique' },
            'MR': { lat: 21.00789, lng: -10.940835, name: 'Mauritania' },
            'MS': { lat: 16.742498, lng: -62.187366, name: 'Montserrat' },
            'MT': { lat: 35.937496, lng: 14.375416, name: 'Malta' },
            'MU': { lat: -20.348404, lng: 57.552152, name: 'Mauritius' },
            'MV': { lat: 3.202778, lng: 73.22068, name: 'Maldives' },
            'MW': { lat: -13.254308, lng: 34.301525, name: 'Malawi' },
            'MX': { lat: 23.634501, lng: -102.552784, name: 'Mexico' },
            'MY': { lat: 4.210484, lng: 101.975766, name: 'Malaysia' },
            'MZ': { lat: -18.665695, lng: 35.529562, name: 'Mozambique' },
            'NA': { lat: -22.95764, lng: 18.49041, name: 'Namibia' },
            'NC': { lat: -20.904305, lng: 165.618042, name: 'New Caledonia' },
            'NE': { lat: 17.607789, lng: 8.081666, name: 'Niger' },
            'NF': { lat: -29.040835, lng: 167.954712, name: 'Norfolk Island' },
            'NG': { lat: 9.081999, lng: 8.675277, name: 'Nigeria' },
            'NI': { lat: 12.865416, lng: -85.207229, name: 'Nicaragua' },
            'NL': { lat: 52.132633, lng: 5.291266, name: 'Netherlands' },
            'NO': { lat: 60.472024, lng: 8.468946, name: 'Norway' },
            'NP': { lat: 28.394857, lng: 84.124008, name: 'Nepal' },
            'NR': { lat: -0.522778, lng: 166.931503, name: 'Nauru' },
            'NU': { lat: -19.054445, lng: -169.867233, name: 'Niue' },
            'NZ': { lat: -40.900557, lng: 174.885971, name: 'New Zealand' },
            'OM': { lat: 21.512583, lng: 55.923255, name: 'Oman' },
            'PA': { lat: 8.537981, lng: -80.782127, name: 'Panama' },
            'PE': { lat: -9.189967, lng: -75.015152, name: 'Peru' },
            'PF': { lat: -17.679742, lng: -149.406843, name: 'French Polynesia' },
            'PG': { lat: -6.314993, lng: 143.95555, name: 'Papua New Guinea' },
            'PH': { lat: 12.879721, lng: 121.774017, name: 'Philippines' },
            'PK': { lat: 30.375321, lng: 69.345116, name: 'Pakistan' },
            'PL': { lat: 51.919438, lng: 19.145136, name: 'Poland' },
            'PM': { lat: 46.941936, lng: -56.27111, name: 'Saint Pierre and Miquelon' },
            'PN': { lat: -24.703615, lng: -127.439308, name: 'Pitcairn Islands' },
            'PR': { lat: 18.220833, lng: -66.590149, name: 'Puerto Rico' },
            'PS': { lat: 31.952162, lng: 35.233154, name: 'Palestinian Territories' },
            'PT': { lat: 39.399872, lng: -8.224454, name: 'Portugal' },
            'PW': { lat: 7.51498, lng: 134.58252, name: 'Palau' },
            'PY': { lat: -23.442503, lng: -58.443832, name: 'Paraguay' },
            'QA': { lat: 25.354826, lng: 51.183884, name: 'Qatar' },
            'RE': { lat: -21.115141, lng: 55.536384, name: 'R√©union' },
            'RO': { lat: 45.943161, lng: 24.96676, name: 'Romania' },
            'RS': { lat: 44.016521, lng: 21.005859, name: 'Serbia' },
            'RU': { lat: 61.52401, lng: 105.318756, name: 'Russia' },
            'RW': { lat: -1.940278, lng: 29.873888, name: 'Rwanda' },
            'SA': { lat: 23.885942, lng: 45.079162, name: 'Saudi Arabia' },
            'SB': { lat: -9.64571, lng: 160.156194, name: 'Solomon Islands' },
            'SC': { lat: -4.679574, lng: 55.491977, name: 'Seychelles' },
            'SD': { lat: 12.862807, lng: 30.217636, name: 'Sudan' },
            'SE': { lat: 60.128161, lng: 18.643501, name: 'Sweden' },
            'SG': { lat: 1.352083, lng: 103.819836, name: 'Singapore' },
            'SH': { lat: -24.143474, lng: -10.030696, name: 'Saint Helena' },
            'SI': { lat: 46.151241, lng: 14.995463, name: 'Slovenia' },
            'SJ': { lat: 77.553604, lng: 23.670272, name: 'Svalbard and Jan Mayen' },
            'SK': { lat: 48.669026, lng: 19.699024, name: 'Slovakia' },
            'SL': { lat: 8.460555, lng: -11.779889, name: 'Sierra Leone' },
            'SM': { lat: 43.766667, lng: 12.416667, name: 'San Marino' },
            'SN': { lat: 14.497401, lng: -14.452362, name: 'Senegal' },
            'SO': { lat: 5.152149, lng: 46.199616, name: 'Somalia' },
            'SR': { lat: 3.919305, lng: -56.027783, name: 'Suriname' },
            'ST': { lat: 0.18636, lng: 6.613081, name: 'Sao Tome and Principe' },
            'SV': { lat: 13.794185, lng: -88.89653, name: 'El Salvador' },
            'SY': { lat: 34.802075, lng: 38.996815, name: 'Syria' },
            'SZ': { lat: -26.522503, lng: 31.465866, name: 'Swaziland' },
            'TC': { lat: 21.694025, lng: -71.797928, name: 'Turks and Caicos Islands' },
            'TD': { lat: 15.454166, lng: 18.732207, name: 'Chad' },
            'TF': { lat: -49.280366, lng: 69.348557, name: 'French Southern Territories' },
            'TG': { lat: 8.619543, lng: 0.824782, name: 'Togo' },
            'TH': { lat: 15.870032, lng: 100.992541, name: 'Thailand' },
            'TJ': { lat: 38.861034, lng: 71.276093, name: 'Tajikistan' },
            'TK': { lat: -8.967363, lng: -171.855881, name: 'Tokelau' },
            'TL': { lat: -8.874217, lng: 125.727539, name: 'Timor-Leste' },
            'TM': { lat: 38.969719, lng: 59.556278, name: 'Turkmenistan' },
            'TN': { lat: 33.886917, lng: 9.537499, name: 'Tunisia' },
            'TO': { lat: -21.178986, lng: -175.198242, name: 'Tonga' },
            'TR': { lat: 38.963745, lng: 35.243322, name: 'Turkey' },
            'TT': { lat: 10.691803, lng: -61.222503, name: 'Trinidad and Tobago' },
            'TV': { lat: -7.109535, lng: 177.64933, name: 'Tuvalu' },
            'TW': { lat: 23.69781, lng: 120.960515, name: 'Taiwan' },
            'TZ': { lat: -6.369028, lng: 34.888822, name: 'Tanzania' },
            'UA': { lat: 48.379433, lng: 31.16558, name: 'Ukraine' },
            'UG': { lat: 1.373333, lng: 32.290275, name: 'Uganda' },
            'UM': { lat: 19.3, lng: 166.633333, name: 'U.S. Minor Outlying Islands' },
            'US': { lat: 37.09024, lng: -95.712891, name: 'United States' },
            'UY': { lat: -32.522779, lng: -55.765835, name: 'Uruguay' },
            'UZ': { lat: 41.377491, lng: 64.585262, name: 'Uzbekistan' },
            'VA': { lat: 41.902916, lng: 12.453389, name: 'Vatican City' },
            'VC': { lat: 12.984305, lng: -61.287228, name: 'Saint Vincent and the Grenadines' },
            'VE': { lat: 6.42375, lng: -66.58973, name: 'Venezuela' },
            'VG': { lat: 18.420695, lng: -64.639968, name: 'British Virgin Islands' },
            'VI': { lat: 18.335765, lng: -64.896335, name: 'U.S. Virgin Islands' },
            'VN': { lat: 14.058324, lng: 108.277199, name: 'Vietnam' },
            'VU': { lat: -15.376706, lng: 166.959158, name: 'Vanuatu' },
            'WF': { lat: -13.768752, lng: -177.156097, name: 'Wallis and Futuna' },
            'WS': { lat: -13.759029, lng: -172.104629, name: 'Samoa' },
            'XK': { lat: 42.602636, lng: 20.902977, name: 'Kosovo' },
            'YE': { lat: 15.552727, lng: 48.516388, name: 'Yemen' },
            'YT': { lat: -12.8275, lng: 45.166244, name: 'Mayotte' },
            'ZA': { lat: -30.559482, lng: 22.937506, name: 'South Africa' },
            'ZM': { lat: -13.133897, lng: 27.849332, name: 'Zambia' },
            'ZW': { lat: -19.015438, lng: 29.154857, name: 'Zimbabwe' }
                    };

                    // Three.js variables
                    let scene, camera, renderer, controls, globe, targetMarker;
                    let routes = [], countryAttacks = {}, multipleCount = 0, totalRowCount = 0, validIPCount = 0;
                    const ipCache = new Map();
                    const EARTH_RADIUS = 5;
                    const countryLabels = [];
                    let raycaster, mouse;

                    function initGlobe() {
                        // Create scene
                        scene = new THREE.Scene();
                        scene.background = new THREE.Color(0x0a0a1a);

                        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
                        camera.position.z = 15;

                        // Create renderer
                        renderer = new THREE.WebGLRenderer({ antialias: true });
                        renderer.setSize(window.innerWidth, window.innerHeight);
                        document.getElementById('globe-container').appendChild(renderer.domElement);

                        // Add orbit controls
                        controls = new THREE.OrbitControls(camera, renderer.domElement);
                        controls.enableDamping = true;
                        controls.dampingFactor = 0.05;
                        controls.rotateSpeed = 0.5;

                        raycaster = new THREE.Raycaster();
                        mouse = new THREE.Vector2();

                        renderer.domElement.addEventListener('click', onMouseClick, false);

                        // Add ambient light
                        const ambientLight = new THREE.AmbientLight(0x333333);
                        scene.add(ambientLight);


                        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
                        directionalLight.position.set(5, 3, 5);
                        scene.add(directionalLight);

                        const geometry = new THREE.SphereGeometry(EARTH_RADIUS, 64, 64);
                        const material = new THREE.MeshPhongMaterial({
                            color: 0x1a1a2e,
                            specular: 0x222222,
                            shininess: 5
                        });

                        globe = new THREE.Mesh(geometry, material);
                        scene.add(globe);

                        addCountryBorders();

                        // Add target marker (Ulaanbaatar)
                        const targetCoords = latLngToVector3(TARGET.lat, TARGET.lng, EARTH_RADIUS + 0.05);
                        const markerGeometry = new THREE.SphereGeometry(0.15, 16, 16);
                        const markerMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                        targetMarker = new THREE.Mesh(markerGeometry, markerMaterial);
                        targetMarker.position.copy(targetCoords);
                        scene.add(targetMarker);

                        // Add glow effect to target
                        const glowGeometry = new THREE.SphereGeometry(0.2, 16, 16);
                        const glowMaterial = new THREE.MeshBasicMaterial({
                            color: 0xff0000,
                            transparent: true,
                            opacity: 0.5
                        });
                        const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                        glow.position.copy(targetCoords);
                        scene.add(glow);

                        // Add pulse animation to target
                        function animateTarget() {
                            const scale = 1 + 0.2 * Math.sin(Date.now() * 0.005);
                            glow.scale.set(scale, scale, scale);
                            requestAnimationFrame(animateTarget);
                        }
                        animateTarget();

                        addStars();


                        animate();

                        window.addEventListener('resize', onWindowResize);
                    }

                    function addCountryBorders() {
                        fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
                            .then(response => response.json())
                            .then(data => {
                                data.features.forEach(feature => {
                                    const coordinates = feature.geometry.coordinates;
                                    if (feature.geometry.type === 'Polygon') {
                                        drawPolygon(coordinates[0]);
                                    } else if (feature.geometry.type === 'MultiPolygon') {
                                        coordinates.forEach(polygon => {
                                            drawPolygon(polygon[0]);
                                        });
                                    }
                                });
                            })
                            .catch(error => console.error('Error loading GeoJSON:', error));
                    }

                    function drawPolygon(coords) {
                        const points = [];
                        coords.forEach(coord => {
                            const [lng, lat] = coord;
                            const vec = latLngToVector3(lat, lng, EARTH_RADIUS + 0.01);
                            points.push(vec);
                        });
                        const geometry = new THREE.BufferGeometry().setFromPoints(points);
                        const material = new THREE.LineBasicMaterial({
                            color: 0x00ff00,
                            transparent: true,
                            opacity: 0.3
                        });
                        const line = new THREE.Line(geometry, material);
                        scene.add(line);
                    }

                    function addStars() {
                        const starGeometry = new THREE.BufferGeometry();
                        const starMaterial = new THREE.PointsMaterial({
                            color: 0xffffff,
                            size: 0.1,
                            transparent: true
                        });

                        const starVertices = [];
                        for (let i = 0; i < 10000; i++) {
                            const x = (Math.random() - 0.5) * 2000;
                            const y = (Math.random() - 0.5) * 2000;
                            const z = (Math.random() - 0.5) * 2000;
                            starVertices.push(x, y, z);
                        }

                        starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
                        const stars = new THREE.Points(starGeometry, starMaterial);
                        scene.add(stars);
                    }

                    function latLngToVector3(lat, lng, radius) {
                        const phi = (90 - lat) * (Math.PI / 180);
                        const theta = (lng + 180) * (Math.PI / 180);

                        const x = -(radius * Math.sin(phi) * Math.cos(theta));
                        const y = radius * Math.cos(phi);
                        const z = radius * Math.sin(phi) * Math.sin(theta);

                        return new THREE.Vector3(x, y, z);
                    }

                    function getColorForCount(count) {
                        if (count <= 100) return 0x9D4EDD;    // Purple
                        if (count <= 250) return 0x4D96FF;    // Blue
                        if (count <= 500) return 0x6BCF7F;    // Green
                        if (count <= 1000) return 0xFFD93D;   // Yellow
                        if (count <= 2500) return 0xFFA500;   // Orange
                        return 0xFF6B6B;                      // Red (danger)
                    }

                    function calculateDistance(start, end) {
                        // Calculate great-circle distance using the Haversine formula
                        const lat1 = start.lat * Math.PI / 180;
                        const lon1 = start.lng * Math.PI / 180;
                        const lat2 = end.lat * Math.PI / 180;
                        const lon2 = end.lng * Math.PI / 180;

                        const dLat = lat2 - lat1;
                        const dLon = lon2 - lon1;

                        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                                  Math.cos(lat1) * Math.cos(lat2) *
                                  Math.sin(dLon/2) * Math.sin(dLon/2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                        const earthRadius = 6371;
                        return earthRadius * c;
                    }

                    function createGreatCirclePoints(startVec, endVec, distance) {
                        const points = [];
                        const segments = 100;

                       
                        const minHeight = 0.5;
                        const maxHeight = 4.0;
                        const heightFactor = Math.pow(distance / 20000, 1.8);
                        const arcHeight = minHeight + (maxHeight * heightFactor);

                        const startNormalized = startVec.clone().normalize();
                        const endNormalized = endVec.clone().normalize();

                        const angle = startNormalized.angleTo(endNormalized);
                        const axis = new THREE.Vector3().crossVectors(startNormalized, endNormalized).normalize();

                        for (let i = 0; i <= segments; i++) {
                            const t = i / segments;

                            const vec = startNormalized.clone().applyAxisAngle(axis, angle * t);

                            const arcOffset = Math.sin(t * Math.PI) * arcHeight;

                            const routePoint = vec.multiplyScalar(EARTH_RADIUS + arcOffset);
                            points.push(routePoint);
                        }

                        return points;
                    }

                    function createRoutePath(startVec, endVec, color, intensity, distance, countryName, count) {
                        const points = createGreatCirclePoints(startVec, endVec, distance);
                        const geometry = new THREE.BufferGeometry().setFromPoints(points);

                        // Adjust line width based on intensity
                        const lineWidth = Math.min(0.05 + Math.log10(intensity) * 0.05, 0.3);

                        const material = new THREE.LineBasicMaterial({
                            color: color,
                            linewidth: lineWidth,
                            transparent: true,
                            opacity: 0.9
                        });

                        const route = new THREE.Line(geometry, material);

                        // Store metadata for interaction
                        route.userData = {
                            type: 'route',
                            country: countryName,
                            count: count,
                            distance: Math.round(distance),
                            color: color
                        };

                        scene.add(route);

                        return route;
                    }

                    function createCountryMarker(position, color, size, countryName, count) {
                        const geometry = new THREE.SphereGeometry(size, 16, 16);
                        const material = new THREE.MeshBasicMaterial({ color: color });
                        const marker = new THREE.Mesh(geometry, material);
                        marker.position.copy(position);

                        // Store metadata for interaction
                        marker.userData = {
                            type: 'marker',
                            country: countryName,
                            count: count
                        };

                        scene.add(marker);

                        return marker;
                    }

                    function createMovingDot(position, color, size = 0.08) {
                        const geometry = new THREE.SphereGeometry(size, 8, 8);
                        const material = new THREE.MeshBasicMaterial({
                            color: color,
                            transparent: true,
                            opacity: 0.9
                        });
                        const dot = new THREE.Mesh(geometry, material);
                        dot.position.copy(position);
                        scene.add(dot);

                        return dot;
                    }

                    function createPulsingDot(position, color) {
                        const geometry = new THREE.SphereGeometry(0.05, 8, 8);
                        const material = new THREE.MeshBasicMaterial({
                            color: color,
                            transparent: true,
                            opacity: 0.8
                        });
                        const dot = new THREE.Mesh(geometry, material);
                        dot.position.copy(position);
                        scene.add(dot);

                        // Add pulsing animation
                        function pulse() {
                            const scale = 1 + 0.3 * Math.sin(Date.now() * 0.005);
                            dot.scale.set(scale, scale, scale);
                            requestAnimationFrame(pulse);
                        }
                        pulse();

                        return dot;
                    }

                    function createCountryLabel(position, countryName, count) {
                        const label = document.createElement('div');
                        label.className = 'country-label';
                        label.textContent = `${countryName} (${count})`;

                        document.body.appendChild(label);

                        function updatePosition() {
                            const vector = position.clone();
                            vector.project(camera);

                            const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
                            const y = (-vector.y * 0.5 + 0.5) * window.innerHeight;

                            // Only show label if it's in front of the camera
                            if (vector.z < 1) {
                                label.style.display = 'block';
                                label.style.left = `${x}px`;
                                label.style.top = `${y}px`;
                            } else {
                                label.style.display = 'none';
                            }
                        }

                        return {
                            element: label,
                            update: updatePosition
                        };
                    }

                    function onMouseClick(event) {
                        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

                        // Update the raycaster
                        raycaster.setFromCamera(mouse, camera);

                        const intersects = raycaster.intersectObjects(scene.children);

                        // Find the first route or marker that was clicked
                        const routeIntersect = intersects.find(intersect =>
                            intersect.object.userData && intersect.object.userData.type === 'route'
                        );

                        const markerIntersect = intersects.find(intersect =>
                            intersect.object.userData && intersect.object.userData.type === 'marker'
                        );

                        const routeInfo = document.getElementById('routeInfo');

                        if (routeIntersect) {
                            const routeData = routeIntersect.object.userData;
                            routeInfo.innerHTML = `
                                <strong>Route Information</strong><br>
                                <strong>From:</strong> ${routeData.country}<br>
                                <strong>To:</strong> Ulaanbaatar, Mongolia<br>
                                <strong>Attacks:</strong> ${routeData.count.toLocaleString()}<br>
                                <strong>Distance:</strong> ${routeData.distance.toLocaleString()} km
                            `;
                            routeInfo.style.display = 'block';
                        } else if (markerIntersect) {
                            const markerData = markerIntersect.object.userData;
                            routeInfo.innerHTML = `
                                <strong>Source Country</strong><br>
                                <strong>Country:</strong> ${markerData.country}<br>
                                <strong>Attacks:</strong> ${markerData.count.toLocaleString()}
                            `;
                            routeInfo.style.display = 'block';
                        } else {
                            routeInfo.style.display = 'none';
                        }
                    }

                    function updateDisplay() {
                        routes.forEach(route => {
                            if (route.path) scene.remove(route.path);
                            if (route.marker) scene.remove(route.marker);
                            if (route.dot) scene.remove(route.dot);
                            if (route.movingDot) scene.remove(route.movingDot);
                        });
                        routes = [];

                        // Remove country labels
                        countryLabels.forEach(label => {
                            if (label.element && label.element.parentNode) {
                                label.element.parentNode.removeChild(label.element);
                            }
                        });
                        countryLabels.length = 0;

                        // Update stats
                        document.getElementById('totalRows').textContent = totalRowCount.toLocaleString();
                        document.getElementById('validIPs').textContent = validIPCount.toLocaleString();
                        document.getElementById('multipleCount').textContent = multipleCount.toLocaleString();
                        document.getElementById('uniqueCountries').textContent = Object.keys(countryAttacks).length;
                        document.getElementById('cachedIPs').textContent = ipCache.size.toLocaleString();

                        const topCountry = Object.entries(countryAttacks).sort((a, b) => b[1] - a[1])[0];
                        if (topCountry) {
                            const name = COUNTRY_COORDS[topCountry[0]]?.name || topCountry[0];
                            document.getElementById('topCountry').textContent = `${name} (${topCountry[1].toLocaleString()})`;
                        }

                        // Create routes for each country
                        Object.entries(countryAttacks).forEach(([code, count]) => {
                            const country = COUNTRY_COORDS[code];
                            if (!country) return;

                            const color = getColorForCount(count);
                            const startPos = latLngToVector3(country.lat, country.lng, EARTH_RADIUS + 0.05);
                            const endPos = latLngToVector3(TARGET.lat, TARGET.lng, EARTH_RADIUS + 0.05);

                            const distance = calculateDistance(country, TARGET);

                            const route = createRoutePath(startPos, endPos, color, count, distance, country.name, count);

                            // Create country marker
                            const markerSize = Math.min(0.08 + Math.log10(count) * 0.03, 0.2);
                            const marker = createCountryMarker(startPos, color, markerSize, country.name, count);

                            // Create moving dot for animation
                            const movingDot = createMovingDot(startPos, color);

                            // Create pulsing dot at the front of the route
                            const dot = createPulsingDot(startPos, color);

                            // Create country label
                            const label = createCountryLabel(startPos, country.name, count);
                            countryLabels.push(label);

                            // Calculate route points for animation
                            const routePoints = createGreatCirclePoints(startPos, endPos, distance);

                            routes.push({
                                path: route,
                                marker: marker,
                                dot: dot,
                                movingDot: movingDot,
                                country: country.name,
                                count: count,
                                routePoints: routePoints,
                                progress: Math.random(), // Random start position for variety
                                speed: 0.006 + (Math.random() * 0.008) // Random speed for variety
                            });
                        });
                    }

                    function animate() {
                        requestAnimationFrame(animate);
                        controls.update();

                        // Update moving dots along routes
                        routes.forEach(route => {
                            if (route.routePoints && route.movingDot) {
                                route.progress += route.speed;
                                if (route.progress >= 1) route.progress = 0;

                                const pointIndex = Math.floor(route.progress * (route.routePoints.length - 1));
                                const fractionalProgress = (route.progress * (route.routePoints.length - 1)) % 1;

                                if (route.routePoints[pointIndex] && route.routePoints[pointIndex + 1]) {
                                    // Interpolate between points for smooth movement
                                    const currentPoint = route.routePoints[pointIndex];
                                    const nextPoint = route.routePoints[pointIndex + 1];

                                    const position = new THREE.Vector3().lerpVectors(
                                        currentPoint,
                                        nextPoint,
                                        fractionalProgress
                                    );

                                    route.movingDot.position.copy(position);

                                    // Add slight pulsing effect to moving dots
                                    const pulseScale = 1 + 0.2 * Math.sin(Date.now() * 0.01);
                                    route.movingDot.scale.set(pulseScale, pulseScale, pulseScale);
                                }
                            }
                        });

                        // Update country label positions
                        countryLabels.forEach(label => {
                            label.update();
                        });

                        renderer.render(scene, camera);
                    }

                    function onWindowResize() {
                        camera.aspect = window.innerWidth / window.innerHeight;
                        camera.updateProjectionMatrix();
                        renderer.setSize(window.innerWidth, window.innerHeight);
                    }

                    // Keep the same data processing functions from the original code
                    async function bulkGeocode(ips) {
                        const uncachedIPs = [];
                        const results = new Array(ips.length);

                        ips.forEach((ip, idx) => {
                            if (ipCache.has(ip)) {
                                results[idx] = ipCache.get(ip);
                            } else {
                                uncachedIPs.push({ ip, idx });
                            }
                        });

                        if (uncachedIPs.length === 0) return results;

                        try {
                            const response = await fetch('http://ip-api.com/batch', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(uncachedIPs.map(item => ({ query: item.ip, fields: 'countryCode' })))
                            });

                            const apiResults = await response.json();

                            apiResults.forEach((r, i) => {
                                const country = r.countryCode || null;
                                const { ip, idx } = uncachedIPs[i];
                                ipCache.set(ip, country);
                                results[idx] = country;
                            });

                            return results;
                        } catch (e) {
                            console.error('Geocoding error:', e);
                            return results.map(r => r === undefined ? null : r);
                        }
                    }

                    async function processFile(file) {
                        const status = document.getElementById('status');
                        status.style.display = 'block';
                        status.textContent = 'Parsing CSV...';

                        countryAttacks = {};
                        multipleCount = 0;
                        totalRowCount = 0;
                        validIPCount = 0;
                        const ipFrequency = new Map();

                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            transformHeader: (h) => h.trim().toLowerCase().replace(/\s+/g, '_'),
                            chunk: (results) => {
                                results.data.forEach(row => {
                                    totalRowCount++;
                                    const ip = row.source_ip_address?.trim();
                                    if (ip && ip.toLowerCase() === 'multiple') {
                                        multipleCount++;
                                    } else if (ip && /^(\d{1,3}\.){3}\d{1,3}$/.test(ip)) {
                                        ipFrequency.set(ip, (ipFrequency.get(ip) || 0) + 1);
                                        validIPCount++;
                                    }
                                });
                            },
                            complete: async () => {
                                const uniqueIPs = Array.from(ipFrequency.keys());
                                const totalUnique = uniqueIPs.length;
                                document.getElementById('uniqueIPs').textContent = totalUnique.toLocaleString();

                                const cachedCount = uniqueIPs.filter(ip => ipCache.has(ip)).length;

                                status.textContent = `Geocoding ${totalUnique.toLocaleString()} unique IPs (${cachedCount.toLocaleString()} cached)...`;

                                for (let i = 0; i < uniqueIPs.length; i += 100) {
                                    const batch = uniqueIPs.slice(i, Math.min(i + 100, uniqueIPs.length));
                                    const countries = await bulkGeocode(batch);

                                    countries.forEach((country, idx) => {
                                        if (country) {
                                            const ip = batch[idx];
                                            const frequency = ipFrequency.get(ip);
                                            countryAttacks[country] = (countryAttacks[country] || 0) + frequency;
                                        }
                                    });

                                    status.textContent = `Geocoded ${Math.min(i + 100, uniqueIPs.length).toLocaleString()}/${totalUnique.toLocaleString()} IPs...`;
                                    await new Promise(r => setTimeout(r, 110));
                                }

                                status.textContent = 'Rendering globe...';
                                updateDisplay();
                                setTimeout(() => { status.style.display = 'none'; }, 2000);
                            }
                        });
                    }

                    document.getElementById('fileInput').addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) processFile(file);
                    });
            document.getElementById('demoBtn').addEventListener('click', () => {
    const status = document.getElementById('status');
    status.style.display = 'block';
    status.textContent = 'Fetching Demo Data...';

    // Fetch the sample CSV file from the repo
    fetch('./sample_data.csv')
        .then(response => {
            if (!response.ok) throw new Error("Sample file not found");
            return response.blob(); // Convert to a Blob (file-like object)
        })
        .then(blob => {
            // Create a File object from the Blob to trick the existing processFile function
            const file = new File([blob], "sample_data.csv", { type: "text/csv" });
            processFile(file); // Reuse your existing logic!
        })
        .catch(error => {
            console.error(error);
            status.textContent = 'Error: Could not load sample_data.csv';
            setTimeout(() => status.style.display = 'none', 3000);
        });
});

        
                    initGlobe();
                    
        </script>
    </body>
</html>

